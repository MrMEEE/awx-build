# Migration issues:

* 2.0.0 -> 2.1.192
```
Issue: 
sudo -u awx /opt/awx/bin/awx-manage makemigrations
CommandError: Conflicting migrations detected; multiple leaf nodes in the migration graph:
(0052_v340_remove_project_scm_delete_on_next_update, 0050_merge_20180926_1745 in main).
To fix them run 'python manage.p1. y makemigrations --merg2. e'

Fix:
 1. /opt/awx/bin/awx-manage makemigrations --merge 
 2. /opt/awx/bin/awx-manage migrate
```
* 2.0.0 -> 2.1.0.74

```
systemctl enable awx-dispatcher.service
systemctl start awx-dispatcher.service
```

* 1.0.6.47 -> 1.0.7.3

sudo -u awx /opt/awx/bin/awx-manage makemigrations --merge

/opt/awx/embedded/lib/python2.7/site-packages/awx/main/migrations/0043_v330_oauth2accesstoken_modified.py

```
# -*- coding: utf-8 -*-
# Generated by Django 1.11.11 on 2018-07-10 14:02
from __future__ import unicode_literals

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('main', '0042_v330_org_member_role_deparent'),
    ]

    operations = [
        migrations.AddField(
            model_name='oauth2accesstoken',
            name='modified',
            field=models.DateTimeField(editable=False,null=True),
        ),
    ]

```

Inserted "null=True"

sudo -u awx /opt/awx/bin/awx-manage migrate

su - postgres
\c awx
ALTER TABLE main_organization ADD COLUMN job_template_admin_role_id integer;
ALTER TABLE main_organization ADD FOREIGN KEY (job_template_admin_role_id) REFERENCES main_rbac_roles(id) DEFERRABLE INITIALLY DEFERRED;

There is an issue with awx-celery-worker, which will be fixed with the next build, but for 1.0.7.3 change:

ExecStart=/opt/awx/bin/celery worker -A awx -B -l info --autoscale=50,4 -Ofair -s /var/lib/awx/beat.db -n celery@%(ENV_HOSTNAME)s
to
ExecStart=/opt/awx/bin/celery worker -A awx -B -l info --autoscale=50,4 -Ofair -s /var/lib/awx/beat.db -n celery@%H

in:

/usr/lib/systemd/system/awx-celery-worker.service

systemctl daemon-reload

systemctl restart awx-celery-worker awx-cbreceiver awx-celery-beat awx-channels-worker awx-daphne awx-web

REF: https://github.com/ansible/awx/issues/2173


* 1.0.6.7 -> 1.0.6.8

Something in rabbitmq changed.. so we need to upgrade to newer RabbitMQ:
```

systemctl stop rabbitmq-server
yum -y remove erlang-erts-R16B-03.18.el7.x86_64
echo "[rabbitmq-erlang]
name=rabbitmq-erlang
baseurl=https://dl.bintray.com/rabbitmq/rpm/erlang/20/el/7
gpgcheck=1
gpgkey=https://dl.bintray.com/rabbitmq/Keys/rabbitmq-release-signing-key.asc
repo_gpgcheck=0
enabled=1" > /etc/yum.repos.d/rabbitmq-erlang.repo
  
yum -y install https://dl.bintray.com/rabbitmq/all/rabbitmq-server/3.7.5/rabbitmq-server-3.7.5-1.el7.noarch.rpm

rm -rf /var/lib/rabbitmq/mnesia/

systemctl start rabbitmq-server

rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl start_app

systemctl restart awx-celery-worker awx-cbreceiver awx-celery-beat awx-channels-worker awx-daphne awx-web
```
comment out these two lines in /etc/awx/settings.py: (will be fixed from version 1.0.6.9)
```
CELERY_ROUTES['awx.main.tasks.cluster_node_heartbeat'] = {'queue': CLUSTER_HOST_ID, 'routing_key': CLUSTER_HOST_ID}
CELERY_ROUTES['awx.main.tasks.purge_old_stdout_files'] = {'queue': CLUSTER_HOST_ID, 'routing_key': CLUSTER_HOST_ID}
```

and change a line in this file: (will be fixed from version 1.0.6.9)
/usr/lib/systemd/system/awx-celery-worker.service
```
ExecStart=/opt/awx/bin/celery worker -A awx -l info --autoscale=4 -Ofair -Q tower_scheduler,tower_broadcast_all,tower,%H -n celery@%H

to

ExecStart=/opt/awx/bin/celery worker -A awx -B -l info --autoscale=50,4 -Ofair -s /var/lib/awx/beat.db -n celery@%(ENV_HOSTNAME)s

```
